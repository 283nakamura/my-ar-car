<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VTOL Pilot Mission</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <style>
      body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Helvetica Neue', Arial, sans-serif; }
      
      /* UI共通レイヤー */
      #ui-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; }
      
      /* メンター用パネル */
      #mentor-panel {
        width: 80%; max-width: 600px; background: rgba(0, 40, 80, 0.85); border: 2px solid #00d4ff; border-radius: 15px; padding: 20px; color: #fff;
        pointer-events: auto; box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); display: none; transform: translateY(20px); transition: 0.5s;
      }
      #mentor-panel.active { display: block; transform: translateY(0); }
      .mentor-header { font-size: 14px; color: #00d4ff; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; }
      .mentor-msg { font-size: 18px; line-height: 1.5; margin-bottom: 15px; }

      /* ボタン類 */
      .action-btn {
        background: #00d4ff; color: #000; border: none; border-radius: 5px; padding: 12px 25px;
        font-weight: bold; font-size: 16px; cursor: pointer; pointer-events: auto;
      }
      .choice-container { display: flex; gap: 20px; justify-content: center; }
      .choice-btn { background: #ffaa00; color: #000; border: none; border-radius: 5px; padding: 15px 20px; font-weight: bold; cursor: pointer; pointer-events: auto; }

      /* 動画コンテナ */
      #video-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 500; background: #000; display: none; }
      video { width: 100%; height: 100%; object-fit: cover; }

      /* フェード */
      #fade-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; opacity: 0; z-index: 2000; pointer-events: none; transition: 1s; }
    </style>
  </head>
  <body>

    <div id="fade-overlay"></div>

    <div id="ui-container">
      <div id="mentor-panel" class="active">
        <div class="mentor-header">Command Center - Mentor</div>
        <div id="mentor-text" class="mentor-msg">「君にこの重要なミッションを任せる。準備ができたらシステムを起動してくれ。」</div>
        <div id="btn-area">
          <button class="action-btn" onclick="startMission()">システム起動（ズーム）</button>
        </div>
      </div>
    </div>

    <div id="video-layer">
      <video id="mission-video" playsinline crossorigin="anonymous" src="niagara.mp4"></video>
    </div>

    <a-scene embedded vr-mode-ui="enabled: false">
      <a-assets>
        <a-asset-item id="car-model" src="beta_alia_vtol_aircraft.glb"></a-asset-item>
      </a-assets>
      <a-sky color="#1a1a2e"></a-sky>
      <a-grid position="0 0 0" rotation="-90 0 0" width="100" height="100" opacity="0.2"></a-grid>
      
      <a-entity id="moving-car" position="-5 0.5 -10">
          <a-gltf-model id="model-entity" src="#car-model" scale="0.1 0.1 0.1" rotation="0 90 0"></a-gltf-model>
      </a-entity>
      <a-entity camera position="0 1.6 0"></a-entity>
    </a-scene>

    <script>
      const mentorPanel = document.getElementById('mentor-panel');
      const mentorText = document.getElementById('mentor-text');
      const btnArea = document.getElementById('btn-area');
      const videoLayer = document.getElementById('video-layer');
      const missionVideo = document.getElementById('mission-video');
      const fade = document.getElementById('fade-overlay');
      const model = document.getElementById('model-entity');
      const car = document.getElementById('moving-car');

      // ① ミッション開始（任命 & ズーム）
      function startMission() {
        // ズーム演出
        model.setAttribute('animation-mixer', "clip: *; timeScale: 5");
        model.setAttribute('animation__zoom', { property: 'scale', to: '0.4 0.4 0.4', dur: 1200, easing: 'easeOutBack' });
        
        // メンターのセリフ更新
        mentorText.innerText = "「よし、システムは正常だ。模型から目を離さず、離陸のタイミングを待て。」";
        btnArea.innerHTML = `<button class="action-btn" onclick="takeOff()">テイクオフ！</button>`;
        
        // 動画の準備
        missionVideo.play().then(() => { missionVideo.pause(); missionVideo.currentTime = 0; });
      }

      // ② 離陸（AR飛行）
      function takeOff() {
        mentorPanel.classList.remove('active');
        car.setAttribute('animation__up', "property: position; from: -5 0.5 -10; to: -5 5 -10; dur: 3000; easing: easeInOutQuad");

        setTimeout(() => {
          car.setAttribute('animation__forward', "property: position; from: -5 5 -10; to: 40 5 -10; dur: 5000; easing: easeInQuad");
          
          setTimeout(() => { fade.style.opacity = "1"; }, 4000);
          
          // ③ 搭乗者視点へ遷移
          setTimeout(() => {
            document.querySelector('a-scene').style.display = 'none';
            videoLayer.style.display = 'block';
            missionVideo.play();
            fade.style.opacity = "0";

            // ④ 途中で波乱発生（動画再生2秒後を想定）
            setTimeout(triggerTrouble, 4000);
          }, 5000);
        }, 3000);
      }

      // ④ 途中で波乱発生
      function triggerTrouble() {
        missionVideo.pause();
        mentorPanel.classList.add('active');
        mentorText.innerText = "「キャプテン、判断が必要だ！滝の水しぶきがいつもより高く、視界が悪化している。」";
        // ⑤ 選択肢の表示
        btnArea.innerHTML = `
          <div class="choice-container">
            <button class="choice-btn" onclick="handleChoice('A')">高度を上げる</button>
            <button class="choice-btn" onclick="handleChoice('B')">ルートをずらす</button>
          </div>
        `;
      }

      // ⑥ 選択肢に応じた映像（今回は同じ動画を継続）
      function handleChoice(option) {
        mentorPanel.classList.remove('active');
        // 本来はここで option ごとに missionVideo.src を変える
        missionVideo.play();

        // ⑦ 終了処理へ（動画が最後まで終わった時を想定）
        missionVideo.onended = () => {
          showEnding();
        };
      }

      // ⑧ メンターからの称賛
      function showEnding() {
        fade.style.opacity = "1";
        setTimeout(() => {
          videoLayer.style.display = 'none';
          mentorPanel.classList.add('active');
          mentorText.innerText = "「見事な判断だった。君のおかげで無事に着陸できたぞ。ミッション完了だ。」";
          // ⑨ 終了ボタン
          btnArea.innerHTML = `<button class="action-btn" onclick="location.reload()">体験を終了する</button>`;
          fade.style.opacity = "0";
        }, 1000);
      }
    </script>
  </body>
</html>
